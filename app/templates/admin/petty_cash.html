{% extends "base.html" %}

{% block title %}Caja Chica - {{ condominium.name }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1"><i class="fas fa-cash-register me-2 text-primary"></i>Caja Chica</h2>
            <p class="text-muted mb-0">Gestión de gastos menores y reposiciones.</p>
        </div>
        <a href="{{ url_for_tenant('admin.admin_condominio_panel') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Volver al Panel
        </a>
    </div>

    <div class="row mb-4">
        <!-- Tarjeta de Saldo -->
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100 bg-primary text-white">
                <div class="card-body text-center py-5">
                    <h5 class="text-uppercase opacity-75 mb-2">Saldo Disponible</h5>
                    <h1 class="display-4 fw-bold mb-0">${{ "%.2f"|format(balance) }}</h1>
                    <small class="opacity-50">Actualizado al instante</small>
                </div>
            </div>
        </div>

        <!-- Formulario de Registro -->
        <div class="col-md-8">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0 text-primary"><i class="fas fa-plus-circle me-2"></i>Registrar Movimiento</h5>
                </div>
                <div class="card-body">
                    <form action="{{ url_for_tenant('petty_cash.nuevo_movimiento') }}" method="POST" enctype="multipart/form-data">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Tipo</label>
                                <select class="form-select" name="type" id="txType" onchange="updateCategories()" required>
                                    <option value="EXPENSE" selected>Gasto (Salida)</option>
                                    <option value="INCOME">Reposición (Entrada)</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Monto ($)</label>
                                <input type="number" step="0.01" min="0.01" class="form-control" name="amount" placeholder="0.00" required>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Categoría</label>
                                <select class="form-select" name="category" id="txCategory" required>
                                    <!-- Opciones dinámicas -->
                                    <option value="TRANSPORTE">Transporte / Taxi</option>
                                    <option value="ALIMENTACION">Alimentación</option>
                                    <option value="SUMINISTROS">Suministros de Oficina</option>
                                    <option value="LIMPIEZA">Materiales de Limpieza</option>
                                    <option value="MANTENIMIENTO">Reparaciones Menores</option>
                                    <option value="OTROS">Otros</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Fecha</label>
                                <input type="date" class="form-control" name="date" value="{{ now_date }}">
                            </div>

                            <div class="col-12">
                                <label class="form-label">Descripción</label>
                                <input type="text" class="form-control" name="description" placeholder="Ej: Compra de focos para la entrada" required>
                            </div>

                            <div class="col-12">
                                <label class="form-label">Comprobante (Opcional)</label>
                                <input type="file" class="form-control" name="receipt_file" accept="image/*,.pdf">
                            </div>

                            <div class="col-12 text-end">
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save me-2"></i>Guardar Movimiento
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de Movimientos -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
            <h5 class="mb-0 text-secondary"><i class="fas fa-list me-2"></i>Historial de Movimientos</h5>
            <!-- Botón de Exportar (Fase 2) -->
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4">Fecha</th>
                            <th>Descripción</th>
                            <th>Categoría</th>
                            <th>Registrado Por</th>
                            <th>Comprobante</th>
                            <th class="text-end pe-4">Monto</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for tx in transactions %}
                        <tr>
                            <td class="ps-4">{{ tx.transaction_date.strftime('%d/%m/%Y') }}</td>
                            <td>{{ tx.description }}</td>
                            <td><span class="badge bg-light text-dark border">{{ tx.category }}</span></td>
                            <td>
                                <small class="text-muted">{{ tx.user.name }}</small>
                            </td>
                            <td>
                                {% if tx.receipt_url %}
                                    <a href="{{ url_for('static', filename=tx.receipt_url) }}" target="_blank" class="btn btn-sm btn-outline-info">
                                        <i class="fas fa-paperclip"></i> Ver
                                    </a>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="text-end pe-4">
                                {% if tx.amount < 0 %}
                                    <span class="text-danger fw-bold">- ${{ "%.2f"|format(tx.amount|abs) }}</span>
                                {% else %}
                                    <span class="text-success fw-bold">+ ${{ "%.2f"|format(tx.amount) }}</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-center py-5 text-muted">
                                <i class="fas fa-inbox fa-3x mb-3 opacity-50"></i>
                                <p>No hay movimientos registrados en la Caja Chica.</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // Script simple para cambiar categorías según tipo
    function updateCategories() {
        const type = document.getElementById('txType').value;
        const catSelect = document.getElementById('txCategory');
        
        const expenseCats = [
            {val: 'TRANSPORTE', text: 'Transporte / Taxi'},
            {val: 'ALIMENTACION', text: 'Alimentación'},
            {val: 'SUMINISTROS', text: 'Suministros de Oficina'},
            {val: 'LIMPIEZA', text: 'Materiales de Limpieza'},
            {val: 'MANTENIMIENTO', text: 'Reparaciones Menores'},
            {val: 'OTROS', text: 'Otros'}
        ];
        
        const incomeCats = [
            {val: 'REPOSICION', text: 'Reposición de Fondos'},
            {val: 'DEVOLUCION', text: 'Devolución de Cambio'},
            {val: 'OTROS', text: 'Otros Ingresos'}
        ];
        
        // Limpiar opciones
        catSelect.innerHTML = '';
        
        const cats = type === 'EXPENSE' ? expenseCats : incomeCats;
        
        cats.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.val;
            opt.text = c.text;
            catSelect.appendChild(opt);
        });
    }
</script>
{% endblock %}
