{% extends "base.html" %}

{% block title %}Panel Maestro - CondoManager{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="text-primary">
                    <i class="fas fa-crown me-2"></i>Panel Maestro
                </h1>
                <span class="badge bg-warning fs-6">MASTER</span>
            </div>

            <!-- Estadísticas Globales -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card border-0 bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 id="total-condominios">0</h4>
                                    <p class="mb-0">Condominios</p>
                                </div>
                                <i class="fas fa-building fa-2x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 id="total-usuarios">0</h4>
                                    <p class="mb-0">Usuarios</p>
                                </div>
                                <i class="fas fa-users fa-2x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 id="condominios-activos">0</h4>
                                    <p class="mb-0">Activos</p>
                                </div>
                                <i class="fas fa-check-circle fa-2x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 id="condominios-pendientes">0</h4>
                                    <p class="mb-0">Pendientes</p>
                                </div>
                                <i class="fas fa-clock fa-2x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Acciones Maestro -->
            <div class="row">
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <i class="fas fa-plus-circle me-2"></i>Crear Condominio
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="card-text">Crear un nuevo condominio en el sistema.</p>
                            <a href="/master/crear-condominio" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>Nuevo Condominio
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <i class="fas fa-list me-2"></i>Gestión Global
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="card-text">Ver todos los condominios y usuarios del sistema.</p>
                            <a href="/master/condominios" class="btn btn-outline-primary me-2">
                                <i class="fas fa-building me-1"></i>Condominios
                            </a>
                            <a href="/master/usuarios" class="btn btn-outline-primary">
                                <i class="fas fa-users me-1"></i>Usuarios
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Condominios Recientes -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>Condominios Recientes
                    </h5>
                </div>
                <div class="card-body">
                    <div id="condominios-recientes" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2 text-muted">Cargando condominios...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Cargar estadísticas del sistema
document.addEventListener('DOMContentLoaded', function() {
    if (!window.authManager || !window.authManager.isAuthenticated()) {
        window.location.href = '/login';
        return;
    }
    
    const user = window.authManager.getUser();
    if (user.role !== 'MASTER') {
        alert('Acceso restringido para usuarios MASTER');
        window.location.href = '/dashboard';
        return;
    }
    
    // Cargar datos del sistema
    cargarEstadisticasMaestro();
});

async function cargarEstadisticasMaestro() {
    try {
        const response = await window.authManager.authFetch('/api/master/estadisticas');
        const data = await response.json();
        
        // Actualizar estadísticas
        document.getElementById('total-condominios').textContent = data.total_condominios || 0;
        document.getElementById('total-usuarios').textContent = data.total_usuarios || 0;
        document.getElementById('condominios-activos').textContent = data.condominios_activos || 0;
        document.getElementById('condominios-pendientes').textContent = data.condominios_pendientes || 0;
        
        // Mostrar condominios recientes
        mostrarCondominiosRecientes(data.condominios_recientes || []);
        
    } catch (error) {
        console.error('Error cargando estadísticas:', error);
        document.getElementById('condominios-recientes').innerHTML = 
            '<p class="text-danger">Error cargando datos</p>';
    }
}

function mostrarCondominiosRecientes(condominios) {
    const container = document.getElementById('condominios-recientes');
    
    if (condominios.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-building fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No hay condominios registrados</h5>
                <p class="text-muted">Crea el primer condominio del sistema</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-hover"><thead><tr>';
    html += '<th>Nombre</th><th>Estado</th><th>Usuarios</th><th>Fecha Creación</th></tr></thead><tbody>';
    
    condominios.forEach(condominio => {
        html += `
            <tr>
                <td>${condominio.name}</td>
                <td><span class="badge ${condominio.status === 'ACTIVO' ? 'bg-success' : 'bg-warning'}">${condominio.status}</span></td>
                <td>${condominio.total_usuarios || 0}</td>
                <td>${new Date(condominio.created_at).toLocaleDateString()}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}
</script>
{% endblock %}