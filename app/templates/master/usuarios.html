{% extends "base.html" %}

{% block title %}Gestión de Usuarios (Maestro){% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card border-0 shadow-lg">
                <div class="card-body p-5">
                    <div class="text-center mb-4">
                        <h2 class="text-primary mb-3"><i class="fas fa-users-cog me-2"></i>Gestión de Usuarios</h2>
                        <p class="lead text-muted">Panel de control global para usuarios del sistema.</p>
                    </div>

                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                    <i class="fas fa-info-circle me-2"></i>{{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}
                    
                    {% if user and user.role == 'MASTER' %}
                        <p>Bienvenido, <strong>{{ user.name }}</strong>. Aquí puedes gestionar todos los usuarios.</p>

                        <!-- Navegación por Pestañas -->
                        <ul class="nav nav-tabs mb-4" id="userTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button" role="tab" aria-controls="pending" aria-selected="true">
                                    Pendientes <span class="badge bg-warning text-dark ms-2">{{ pending_users|length }}</span>
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="active-tab" data-bs-toggle="tab" data-bs-target="#active" type="button" role="tab" aria-controls="active" aria-selected="false">
                                    Activos <span class="badge bg-success ms-2">{{ active_users|length }}</span>
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="rejected-tab" data-bs-toggle="tab" data-bs-target="#rejected" type="button" role="tab" aria-controls="rejected" aria-selected="false">
                                    Rechazados <span class="badge bg-danger ms-2">{{ rejected_users|length }}</span>
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button" role="tab" aria-controls="all" aria-selected="false">
                                    Todos <span class="badge bg-secondary ms-2">{{ all_users|length }}</span>
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="create-user-tab" data-bs-toggle="tab" data-bs-target="#create-user" type="button" role="tab" aria-controls="create-user" aria-selected="false">
                                    <i class="fas fa-user-plus me-2"></i>Crear Usuario
                                </button>
                            </li>
                        </ul>

                        <!-- Contenido de las Pestañas -->
                        <div class="tab-content" id="userTabsContent">
                            <!-- Pestaña de Usuarios Pendientes -->
                            <div class="tab-pane fade show active" id="pending" role="tabpanel" aria-labelledby="pending-tab">
                                <div class="card border-0 shadow-sm mb-4">
                                    <div class="card-header bg-warning text-dark">
                                        <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Usuarios Pendientes de Aprobación</h5>
                                    </div>
                                    <div class="card-body">
                                        {% if pending_users %}
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Nombre</th>
                                                            <th>Email</th>
                                                            <th>Rol</th>
                                                            <th>Tenant</th>
                                                            <th>Fecha Registro</th>
                                                            <th>Acciones</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for u in pending_users %}
                                                        <tr>
                                                            <td>{{ u.name }}</td>
                                                            <td>{{ u.email }}</td>
                                                            <td>{{ u.role }}</td>
                                                            <td><span class="badge bg-primary">{{ u.tenant }}</span></td>
                                                            <td>{{ u.created_at.strftime('%d/%m/%Y %H:%M') if u.created_at else 'N/A' }}</td>
                                                            <td>
                                                                <div class="btn-group btn-group-sm">
                                                                    <a href="{{ url_for('admin.aprobar_usuario', user_id=u.id) }}" class="btn btn-success">
                                                                        <i class="fas fa-check"></i> Aprobar
                                                                    </a>
                                                                    <a href="{{ url_for('admin.rechazar_usuario', user_id=u.id) }}" class="btn btn-danger">
                                                                        <i class="fas fa-times"></i> Rechazar
                                                                    </a>
                                                                    <a href="{{ url_for('master.master_usuarios_editar', user_id=u.id) }}" class="btn btn-info">
                                                                        <i class="fas fa-edit"></i>
                                                                    </a>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        {% else %}
                                            <div class="text-center py-4">
                                                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                                                <h5 class="text-muted">No hay usuarios pendientes de aprobación.</h5>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- Pestaña de Usuarios Activos -->
                            <div class="tab-pane fade" id="active" role="tabpanel" aria-labelledby="active-tab">
                                <div class="card border-0 shadow-sm mb-4">
                                    <div class="card-header bg-success text-white">
                                        <h5 class="mb-0"><i class="fas fa-check-circle me-2"></i>Usuarios Activos</h5>
                                    </div>
                                    <div class="card-body">
                                        {% if active_users %}
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Nombre</th>
                                                            <th>Email</th>
                                                            <th>Rol</th>
                                                            <th>Tenant</th>
                                                            <th>Fecha Registro</th>
                                                            <th>Acciones</th> <!-- Para ver detalles o editar si es necesario -->
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for u in active_users %}
                                                        <tr>
                                                            <td>{{ u.name }}</td>
                                                            <td>{{ u.email }}</td>
                                                            <td>{{ u.role }}</td>
                                                            <td><span class="badge bg-primary">{{ u.tenant }}</span></td>
                                                            <td>{{ u.created_at.strftime('%d/%m/%Y %H:%M') if u.created_at else 'N/A' }}</td>
                                                            <td>
                                                                <div class="btn-group btn-group-sm">
                                                                    <a href="{{ url_for('master.master_usuarios_editar', user_id=u.id) }}" class="btn btn-info">
                                                                        <i class="fas fa-edit"></i> Editar
                                                                    </a>
                                                                    <a href="{{ url_for('master.master_usuarios_eliminar', user_id=u.id) }}" class="btn btn-danger">
                                                                        <i class="fas fa-trash"></i> Eliminar
                                                                    </a>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        {% else %}
                                            <div class="text-center py-4">
                                                <i class="fas fa-info-circle fa-3x text-info mb-3"></i>
                                                <h5 class="text-muted">No hay usuarios activos registrados.</h5>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- Pestaña de Usuarios Rechazados -->
                            <div class="tab-pane fade" id="rejected" role="tabpanel" aria-labelledby="rejected-tab">
                                <div class="card border-0 shadow-sm mb-4">
                                    <div class="card-header bg-danger text-white">
                                        <h5 class="mb-0"><i class="fas fa-times-circle me-2"></i>Usuarios Rechazados</h5>
                                    </div>
                                    <div class="card-body">
                                        {% if rejected_users %}
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Nombre</th>
                                                            <th>Email</th>
                                                            <th>Rol</th>
                                                            <th>Tenant</th>
                                                            <th>Fecha Registro</th>
                                                            <th>Acciones</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for u in rejected_users %}
                                                        <tr>
                                                            <td>{{ u.name }}</td>
                                                            <td>{{ u.email }}</td>
                                                            <td>{{ u.role }}</td>
                                                            <td><span class="badge bg-primary">{{ u.tenant }}</span></td>
                                                            <td>{{ u.created_at.strftime('%d/%m/%Y %H:%M') if u.created_at else 'N/A' }}</td>
                                                            <td>
                                                                <div class="btn-group btn-group-sm">
                                                                    <a href="{{ url_for('master.master_usuarios_reaprobar', user_id=u.id) }}" class="btn btn-success">
                                                                        <i class="fas fa-redo"></i> Reaprobar
                                                                    </a>
                                                                    <a href="{{ url_for('master.master_usuarios_eliminar', user_id=u.id) }}" class="btn btn-danger">
                                                                        <i class="fas fa-trash"></i> Eliminar
                                                                    </a>
                                                                    <a href="{{ url_for('master.master_usuarios_editar', user_id=u.id) }}" class="btn btn-info">
                                                                        <i class="fas fa-edit"></i>
                                                                    </a>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        {% else %}
                                            <div class="text-center py-4">
                                                <i class="fas fa-info-circle fa-3x text-info mb-3"></i>
                                                <h5 class="text-muted">No hay usuarios rechazados.</h5>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- Pestaña de Todos los Usuarios -->
                            <div class="tab-pane fade" id="all" role="tabpanel" aria-labelledby="all-tab">
                                <div class="card border-0 shadow-sm mb-4">
                                    <div class="card-header bg-secondary text-white">
                                        <h5 class="mb-0"><i class="fas fa-users me-2"></i>Todos los Usuarios (Todos los Tenants)</h5>
                                    </div>
                                    <div class="card-body">
                                        {% if all_users %}
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Nombre</th>
                                                            <th>Email</th>
                                                            <th>Rol</th>
                                                            <th>Tenant</th>
                                                            <th>Estado</th>
                                                            <th>Fecha Registro</th>
                                                            <th>Acciones</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for u in all_users %}
                                                        <tr>
                                                            <td>{{ u.name }}</td>
                                                            <td>{{ u.email }}</td>
                                                            <td>{{ u.role }}</td>
                                                            <td><span class="badge bg-primary">{{ u.tenant }}</span></td>
                                                            <td>
                                                                {% if u.status == 'active' %}
                                                                    <span class="badge bg-success">Activo</span>
                                                                {% elif u.status == 'pending' %}
                                                                    <span class="badge bg-warning text-dark">Pendiente</span>
                                                                {% else %}
                                                                    <span class="badge bg-danger">Rechazado</span>
                                                                {% endif %}
                                                            </td>
                                                            <td>{{ u.created_at.strftime('%d/%m/%Y %H:%M') if u.created_at else 'N/A' }}</td>
                                                            <td>
                                                                <div class="btn-group btn-group-sm">
                                                                    <a href="{{ url_for('master.master_usuarios_editar', user_id=u.id) }}" class="btn btn-info">
                                                                        <i class="fas fa-edit"></i> Editar
                                                                    </a>
                                                                    <a href="{{ url_for('master.master_usuarios_eliminar', user_id=u.id) }}" class="btn btn-danger">
                                                                        <i class="fas fa-trash"></i> Eliminar
                                                                    </a>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        {% else %}
                                            <div class="text-center py-4">
                                                <i class="fas fa-info-circle fa-3x text-info mb-3"></i>
                                                <h5 class="text-muted">No hay usuarios registrados en el sistema.</h5>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- Pestaña: Crear Usuario -->
                            <div class="tab-pane fade" id="create-user" role="tabpanel" aria-labelledby="create-user-tab">
                                <div class="card border-0 shadow-sm mb-4">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="mb-0"><i class="fas fa-user-plus me-2"></i>Crear Nuevo Usuario</h5>
                                    </div>
                                    <div class="card-body">
                                        <form action="{{ url_for('master.master_usuarios') }}" method="POST">
                                            <input type="hidden" name="action" value="create_user">
                                            <div class="mb-3">
                                                <label for="new_user_name" class="form-label">Nombre</label>
                                                <input type="text" class="form-control" id="new_user_name" name="name" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="new_user_email" class="form-label">Email</label>
                                                <input type="email" class="form-control" id="new_user_email" name="email" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="new_user_password" class="form-label">Contraseña (opcional)</label>
                                                <input type="password" class="form-control" id="new_user_password" name="password">
                                                <small class="form-text text-muted">Si no se proporciona, el usuario deberá usar la función de recuperación de contraseña.</small>
                                            </div>
                                            <div class="mb-3">
                                                <label for="new_user_phone" class="form-label">Teléfono</label>
                                                <input type="text" class="form-control" id="new_user_phone" name="phone">
                                            </div>
                                            <div class="mb-3">
                                                <label for="new_user_city" class="form-label">Ciudad</label>
                                                <input type="text" class="form-control" id="new_user_city" name="city">
                                            </div>
                                            <div class="mb-3">
                                                <label for="new_user_country" class="form-label">País</label>
                                                <input type="text" class="form-control" id="new_user_country" name="country" value="Ecuador">
                                            </div>
                                            <div class="mb-3">
                                                <label for="new_user_role" class="form-label">Rol</label>
                                                <select class="form-select" id="new_user_role" name="role" required>
                                                    <option value="USER">Usuario</option>
                                                    <option value="ADMIN">Administrador</option>
                                                </select>
                                            </div>
                                            <div class="mb-3" id="condominium_select_container" style="display: none;">
                                                <label for="new_user_condominium" class="form-label">Asignar a Condominio (solo para Administrador)</label>
                                                <select class="form-select" id="new_user_condominium" name="condominium_id">
                                                    <option value="">Seleccionar Condominio</option>
                                                    {% for condo in all_condominiums %}
                                                        <option value="{{ condo.id }}">{{ condo.name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-user-plus me-2"></i>Crear Usuario
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <div class="text-center mt-5">
                            <a href="{{ url_for('master.master_panel') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Volver al Panel Maestro
                            </a>
                        </div>

                    {% else %}
                        <div class="alert alert-warning text-center" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            No tienes acceso a la Gestión de Usuarios. Por favor, <a href="{{ url_for('public.login') }}" class="alert-link">inicia sesión</a> con una cuenta MASTER.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // JavaScript para mostrar/ocultar el selector de condominio basado en el rol
    document.addEventListener('DOMContentLoaded', function() {
        const roleSelect = document.getElementById('new_user_role');
        const condominiumContainer = document.getElementById('condominium_select_container');

        function toggleCondominiumSelect() {
            if (roleSelect.value === 'ADMIN') {
                condominiumContainer.style.display = 'block';
            } else {
                condominiumContainer.style.display = 'none';
            }
        }

        roleSelect.addEventListener('change', toggleCondominiumSelect);
        toggleCondominiumSelect(); // Llamar al cargar para establecer el estado inicial
    });
</script>
{% endblock %}
